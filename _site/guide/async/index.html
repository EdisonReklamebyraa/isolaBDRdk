<h1 id="fetching-data">Fetching Data</h1>

<p>The age old debate, where should async go? There is no right answer right now and don’t feel bad if you’re putting it in actions or in stores. In this tutorial, we’ll be calling async from the actions and the data fetching will exist in a new folder <code>utils</code>. This tutorial will handle fetching the data and failure states.</p>

<p>So we create <code>utils/LocationsFetcher.js</code>. We can use something like <a href="https://github.com/github/fetch">fetch</a> to fetch some data from a server, but for the purposes of this tutorial we’ll just simulate an XHR with good ol’ <code>setTimeout</code> and <code>Promise</code> so we copy fetch’s API.</p>

<p>Here’s some mock data we’ll be using</p>

<p><code>js
var mockData = [
  { id: 0, name: 'Abu Dhabi' },
  { id: 1, name: 'Berlin' },
  { id: 2, name: 'Bogota' },
  { id: 3, name: 'Buenos Aires' },
  { id: 4, name: 'Cairo' },
  { id: 5, name: 'Chicago' },
  { id: 6, name: 'Lima' },
  { id: 7, name: 'London' },
  { id: 8, name: 'Miami' },
  { id: 9, name: 'Moscow' },
  { id: 10, name: 'Mumbai' },
  { id: 11, name: 'Paris' },
  { id: 12, name: 'San Francisco' }
];
</code></p>

<p>So let’s create the LocationsFetcher.</p>

<p><code>utils/LocationsFetcher.js</code></p>

<p>```js
var LocationsFetcher = {
  fetch: function () {
    // returning a Promise because that is what fetch does.
    return new Promise(function (resolve, reject) {
      // simulate an asynchronous action where data is fetched on
      // a remote server somewhere.
      setTimeout(function () {</p>

<pre><code>    // resolve with some mock data
    resolve(mockData);
  }, 250);
});   } }; ```
</code></pre>

<p>Next, we’ll need to change the actions to use this new method we created. We will add an action called <code>fetchLocations</code> which will fetch the locations and then call <code>updateLocations</code> when it successfully completes. A new action is also added, <code>locationsFailed</code> which deals with the locations not being available. Add these methods to the class.</p>

<p><code>actions/LocationActions.js</code></p>

<p>```js
fetchLocations() {
  // we dispatch an event here so we can have “loading” state.
  this.dispatch();</p>

<p>LocationsFetcher.fetch()
    .then((locations) =&gt; {
      // we can access other actions within our action through <code>this.actions</code>
      this.actions.updateLocations(locations);
    })
    .catch((errorMessage) =&gt; {
      this.actions.locationsFailed(errorMessage);
    });
}</p>

<p>locationsFailed(errorMessage) {
  this.dispatch(errorMessage);
}
```</p>

<p>Next we’ll update our store to handle these new actions. It’s just a matter of adding the new actions and their handlers to <code>bindListeners</code>. We’ll be adding a new piece of state though, ‘errorMessage’ to deal with any potential error messages.</p>

<p><code>stores/LocationStore.js</code></p>

<p>```js
class LocationStore {
  constructor() {
    this.locations = [];
    this.errorMessage = null;</p>

<pre><code>this.bindListeners({
  handleUpdateLocations: LocationActions.UPDATE_LOCATIONS,
  handleFetchLocations: LocationActions.FETCH_LOCATIONS,
  handleLocationsFailed: LocationActions.LOCATIONS_FAILED
});   }
</code></pre>

<p>handleUpdateLocations(locations) {
    this.locations = locations;
    this.errorMessage = null;
  }</p>

<p>handleFetchLocations() {
    // reset the array while we’re fetching new locations so React can
    // be smart and render a spinner for us since the data is empty.
    this.locations = [];
  }</p>

<p>handleLocationsFailed(errorMessage) {
    this.errorMessage = errorMessage;
  }
}
```</p>

<p>And finally, the view will change slightly. We’ll be displaying an error message if it exists and showing a spinner if the content is loading.</p>

<p>```js
componentDidMount() {
  LocationStore.listen(this.onChange);</p>

<p>LocationActions.fetchLocations();
},</p>

<p>render() {
  if (this.state.errorMessage) {
    return (
      &lt;div&gt;Something is wrong&lt;/div&gt;
    );
  }</p>

<p>if (!this.state.locations.length) {
    return (
      &lt;div&gt;
        <img src="/my-cool-spinner.gif" />
      &lt;/div&gt;
    )
  }</p>

<p>return (
    &lt;ul&gt;
      {this.state.locations.map((location) =&gt; {
        return (
          &lt;li&gt;{location.name}&lt;/li&gt;
        );
      })}
    &lt;/ul&gt;
  );
}
```</p>

<p><a href="wait-for.md">Continue to next step…</a></p>
