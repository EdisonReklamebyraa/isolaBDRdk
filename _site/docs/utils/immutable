<h1 id="using-immutable-data-structures">Using Immutable Data Structures</h1>

<p>With React’s virtual DOM, immutable data structures make a lot of sense to make diffing more efficient, and immutable data structures have the additional benefit of preventing views from updating store data in a Flux architecture. For reasons like this, it makes a lot of sense to incorporate immutable data structures into your alt app, and where they come into play primarily is in your stores.</p>

<p>We will focus on Facebook’s <a href="http://facebook.github.io/immutable-js/">Immutable</a> library.</p>

<h2 id="alt-3s-immutable">Alt &lt;3s Immutable</h2>

<p>Alt has first-class support for immutable data structures via the ImmutableUtil.</p>

<p>Getting started is simple, you’ll require the utility and pass your pre-wrapped stores to it.</p>

<p><code>js
var alt = new Alt();
var immutable = require('alt/utils/ImmutableUtil');
</code></p>

<p>If you’re using babel with ES7 Stage 1 <a href="https://github.com/wycats/javascript-decorators">decorator</a> support then this is sweet.</p>

<p>```js
@immutable
class TodoStore {
  static displayName = ‘TodoStore’</p>

<p>constructor() {
    this.state = {
      todos: Immutable.Map({})
    };
  }
}</p>

<p>alt.createStore(TodoStore);
```</p>

<p>If you don’t wish to use ES7 decorators then no problem, they’re just sugar for function calls. You can just pass your store into the immutable function.</p>

<p>```js
function TodoStore() {
  this.state = {
    todos: Immutable.Map({})
  };
}
TodoStore.displayName = ‘TodoStore’;</p>

<p>alt.createStore(immutable(TodoStore));
```</p>

<p>A few things to note about immutable stores about this approach:</p>

<ul>
  <li>You use <code>this.state</code> to create your state rather than assigning directly to instance properties.</li>
  <li>You specify your own Immutable data structure you wish to use. In this example we’re using Map.</li>
</ul>

<p>Using your ImmutableStore is a bit different from using a regular store:</p>

<p>```js
function TodoStore() {
  this.state = {
    todos: Immutable.Map({})
  };</p>

<p>this.bindListeners({
    addTodo: TodoActions.addTodo
  });
}</p>

<p>TodoStore.properties.addTodo = function (todo) {
  var id = String(Math.random());
  this.setState(this.state.todos.set(id, todo));
};</p>

<p>TodoStore.displayName = ‘TodoStore’;</p>

<p>var todoStore = alt.createStore(immutable(TodoStore));
```</p>

<ul>
  <li>You’ll be using <code>setState</code> in order to modify state within the store.</li>
  <li>You can access the immutable object by using the accessor of <code>this.state</code>. In this example we’re using Map’s <code>set</code> method to set a new key and value.</li>
</ul>

<p><code>js
todoStore.getState() // Immutable.Map
</code></p>

<p><code>getState</code> will return the Immutable object. This means if you’re using React you can use something like <code>===</code> in <code>shouldComponentUpdate</code> to get the performance benefits.</p>

<p>If you wish to convert your structure to a JS object/from a JS object you can use Immutable’s <code>toJS()</code> and <code>fromJS()</code> methods.</p>

<p>Last but not least, snapshots and bootstrapping just works when you’re using this util. The data structures are serialized and deserialized automatically.</p>

<h2 id="manually-using-immutablejs-in-your-stores">Manually using ImmutableJS in your Stores</h2>

<h4 id="record"><code>Record</code></h4>

<p>One of the easiest ways to start getting some of the benefits of immutable is to take advantage of Immutable’s <a href="http://facebook.github.io/immutable-js/docs/#/Record"><code>Record</code></a> types. This method will result in the smallest changes for existing projects. You can read more about them on Facebook’s docs, but the best thing about Records is that they enable you to access values the same way you would from a normal JS object (<code>object.prop</code>). This means no changes to the view code using the immutable data and our changes only occur in store methods that return data to the view.</p>

<p>Here is an example of how a Record can be used:</p>

<p>```js
// MyStore.js
import {Record} from ‘immutable’;</p>

<p>class MyStore {
  constructor() {
    this.data = {
      prop1: 1,
      prop2: 2
    };
  }</p>

<p>getImmutState() {
    var ObjectRecord = Record(this.getState());
    return new ObjectRecord();
  }
}</p>

<p>// MyComponent.js
import {Component} from ‘react’;
import MyStore from ‘stores/MyStore’;</p>

<p>class MyComponent extends Component {
  render() {
    var storeData = MyStore.getImmutState();
    return (
      &lt;div&gt;Prop1: {storeData.prop1}&lt;/div&gt;
    );
  }
}
```</p>

<h4 id="fromjs"><code>fromJS</code></h4>

<p>Immutable has a nice helper, <a href="http://facebook.github.io/immutable-js/docs/#/fromJS"><code>fromJS</code></a> that allows us to convert JS object/arrays to immutable <a href="http://facebook.github.io/immutable-js/docs/#/Map"><code>Map</code>s</a> and <a href="http://facebook.github.io/immutable-js/docs/#/List"><code>List</code>s</a>. This is an easy way to convert plain JS store data to immutable data structures before sending to the view. Unlike the “Record method” described above, you must remember to use getters to access data within these immutable objects.</p>

<p>Here is an example of using <code>fromJS</code> to return immutable data:</p>

<p>```js
// MyStore.js
import Immutable from ‘immutable’;</p>

<p>class MyStore {
  constructor() {
    this.data = {
      prop1: 1,
      prop2: 2
    };
  }</p>

<p>getImmutState() {
    return Immutable.fromJS(this.getState());
  }
}</p>

<p>// MyComponent.js
import {Component} from ‘react’;
import MyStore from ‘stores/MyStore’;</p>

<p>class MyComponent extends Component {
  render() {
    var storeData = MyStore.getImmutState().get(‘data’);
    return (
      &lt;div&gt;Prop1: {storeData.get(‘prop1’)}&lt;/div&gt;
    );
  }
}
```</p>

<h3 id="using-immutable-data-in-storeseverywhere">Using Immutable Data in Stores/Everywhere</h3>

<p>You can also use Immutable’s data structures in your stores or throughout your app. You just need to remember that you need to use getters to access the data in your views or wherever you are reading it.</p>

<p>Immutable provides many nice data structures like <a href="http://facebook.github.io/immutable-js/docs/#/Map"><code>Map</code></a>, <a href="http://facebook.github.io/immutable-js/docs/#/List"><code>List</code></a>, <a href="http://facebook.github.io/immutable-js/docs/#/Set"><code>Set</code></a>, etc.</p>

<p>Here is a basic example of using immutable data structures in your stores, rather than just returning immutable data structures to the view from them.</p>

<p>```js
// MyStore.js
import {Map} from ‘immutable’;</p>

<p>class MyStore {
  constructor() {
    this.data = new Map({
      prop1: 1,
      prop2: 2
    });
  }</p>

<p>onUpdateProp1(newProp1) {
    this.data = this.data.set(‘prop1’, newProp1);
  }
}</p>

<p>// MyComponent.js
import {Component} from ‘react’;
import MyStore from ‘stores/MyStore’;</p>

<p>class MyComponent extends Component {
  render() {
    var storeData = MyStore.getState().get(‘data’);
    return (
      &lt;div&gt;Prop1: {storeData.get(‘prop1’)}&lt;/div&gt;
    );
  }
}
```</p>

<h3 id="serializingdeserializing-immutable-data">Serializing/Deserializing Immutable Data</h3>

<p>If you are using immutable data and plan on taking advantage of alt’s <a href="../takeSnapshot.md">snapshot</a> and <a href="../bootstrap.md">bootstrap</a> capabilities you must ensure that <a href="../lifecycleListeners.md#serialize">serialize</a> and <a href="../lifecycleListeners.md#deserialize">deserialize</a> handle the immutable data.</p>

<p>Serialize returns the data from the store to be used in a snapshot so the immutable getters will need to be used to return a plain JS object to be serialized.</p>

<p>Deserialize takes bootstrap data and uses it to set the state of the store. This means in order for your store to function as you initially set it up, the bootstrapped data must be converted back to immutable data structures.</p>

<p>Example serialize/deserialize with immutable data structures:</p>

<p>```js
// MyStore.js
import Immutable, {Map} from ‘immutable’;</p>

<p>class MyStore {
  constructor() {</p>

<pre><code>this.on('serialize', () =&gt; {
  return {
    data: this.data.toJS()
  };
});

this.on('deserialize', (data) =&gt; {
  return Immutable.fromJS({
    prop1: data.prop1,
    prop2: data.prop2
  });
});

this.data = new Map({
  prop1: 1,
  prop2: 2
});   } } ```
</code></pre>
