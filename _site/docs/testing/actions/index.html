<h1 id="testing-actions">Testing Actions</h1>

<h2 id="conceptual-how-to">Conceptual how to</h2>

<p>The good news about testing actions is that you probably won’t have to do a lot of testing! Most Flux actions just pass data directly to the dispatcher, which then gets passed to the store to be handled.</p>

<p>However, there are instances where actions will modify the data in some way before passing it on to the dispatcher. We can test these by “spying on”/listening to the dispatcher and ensuring that <code>alt.dispatcher.dispatch</code> is called with the correct payload.</p>

<p>An action might also have other side effects such as calling another action, in which case we might also need to “spy” on that action to ensure that it is also called correctly.</p>

<p>Let’s jump into it with an example:</p>

<h1 id="example">Example</h1>

<p>You can also download and run this <a href="https://github.com/jdlehman/alt-example-tests">example</a>.</p>

<h2 id="action">Action</h2>
<p>```javascript
import alt from ‘MyAlt’;
import legalActions from ‘actions/LegalActions’;</p>

<p>class PetActions {
  constructor() {
    // these we do not need to test as we trust alt tests <code>generateActions</code>
    this.generateActions(‘buyPet’, ‘sellPet’);
  }</p>

<p>// this action modifies the dispatched data AND calls another action
  buyExoticPet({pet, cost}) {
    var importCost = 1000,
        illegalAnimals = [‘dragon’, ‘unicorn’, ‘cyclops’],
        // adds import charge to cost
        totalCost = importCost + cost;</p>

<pre><code>this.dispatch({
  pet,
  cost: totalCost
});

// checks if pet is legal
if(illegalAnimals.indexOf(pet) &gt;= 0) {
  legalActions.illegalPet(pet);
}   } }
</code></pre>

<p>export default alt.createActions(PetActions);
```</p>

<h2 id="action-test">Action Test</h2>

<p>```javascript
import alt from ‘MyAlt’;
import petActions from ‘actions/PetActions’;
import legalActions from ‘actions/LegalActions’;
// you can use any assertion lib you want
import {assert} from ‘chai’;
// we will use <a href="http://sinonjs.org/docs/">sinon</a> for spying, but you can use any similar lib
import sinon from ‘sinon’;</p>

<p>describe(‘PetActions’, () =&gt; {
  beforeEach(() =&gt; {
    // here we use sinon to create a spy on the alt.dispatcher.dispatch function
    this.dispatcherSpy = sinon.spy(alt.dispatcher, ‘dispatch’);
    this.illegalSpy = sinon.spy(legalActions, ‘illegalPet’);
  });</p>

<p>afterEach(() =&gt; {
    // clean up our sinon spy so we do not affect other tests
    alt.dispatcher.dispatch.restore();
    legalActions.illegalPet.restore();
  });</p>

<p>describe(‘#buyExoticPet’, () =&gt; {
    it(‘dispatches correct data’, () =&gt; {
      var pet = ‘moose’,
          cost = 18.20,
          totalCost = 1000 + cost,
          action = petActions.BUY_EXOTIC_PET;</p>

<pre><code>  // fire the action
  petActions.buyExoticPet({pet, cost});
  // use our spy to see what payload the dispatcher was called with
  // this lets us ensure that the expected payload (with US dollars) was fired
  var dispatcherArgs = this.dispatcherSpy.args[0];
  var firstArg = dispatcherArgs[0];
  assert.equal(firstArg.action, action);
  assert.deepEqual(firstArg.data, {pet, cost: totalCost});
});

it('does not fire illegal action for legal pets', () =&gt; {
  var pet = 'dog',
      cost = 18.20;

  // fire the action
  petActions.buyExoticPet({pet, cost});
  // use our spy to ensure that the illegal action was NOT called
  assert.equal(this.illegalSpy.callCount, 0);
});

it('fires illegal action for illegal pets', () =&gt; {
  var pet = 'unicorn',
      cost = 18.20;

  // fire the action
  petActions.buyExoticPet({pet, cost});
  // use our spy to ensure that the illegal action was called
  assert(this.illegalSpy.calledOnce, 'the illegal action was not fired');
});   }); }); ```
</code></pre>
